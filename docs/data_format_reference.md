# DeepExtract: Database Schema and Binary Analysis Data Format

This document provides a technical reference for the data architecture, schemas, and analysis heuristics generated by the **DeepExtract** binary analysis plugin for IDA Pro.

---

## System Overview

DeepExtract is an IDA Pro plugin that converts binary executables into a structured, queryable data format. The system executes semantic analysis to resolve indirect calls, reconstruct C++ class structures, and identify security-relevant code patterns.

### Data Architecture

The structured output uses a SQLite-based storage model supporting concurrent analysis and large-scale binary repositories.

1.  **Tracking Database (`analyzed_files.db`)**: A registry tracking the status, cryptographic hashes, and metadata of all binaries in the analysis pipeline.
2.  **Individual Analysis Databases (`{filename}_{hash}.db`)**: Databases containing semantic extraction data for a single binary, including disassembled/decompiled code, resolved cross-references, and heuristic scores.
3.  **C++ Reconstructions**: When configured, the plugin generates a filesystem hierarchy of `.cpp` and `.h` files containing decompiled code and reconstructed class definitions for offline audit.

---

## Analysis Heuristics for Prioritization

DeepExtract applies heuristics to rank functions by vulnerability probability. These are stored as structured JSON in the `functions` table.

### 1. Loop Complexity (`loop_analysis`)

- **Algorithm**: Uses **Tarjan's Strongly Connected Components (SCC)** for $O(V+E)$ detection of reducible and irreducible loops, combined with **Dominator-based back edge analysis** for natural loops.
- **Metric**: `loop_count`, nesting level, cyclomatic complexity ($E - N + 2P$), and exit condition count.

### 2. Dangerous API Sink Detection (`dangerous_api_calls`)

- **Metric**: Presence of security-sensitive functions defined in `dangerous_apis.json` (e.g., `strcpy`, `memcpy`, `system`, `WinExec`).
- **Detection**: Strips import thunk prefixes (`__imp_`, `_o_`) and identifies **WPP (Windows Software Tracing)** patterns.

### 3. Semantic String Analysis (`string_literals`)

- **Metric**: Extraction of strings referenced within a function scope, including heuristics for printable ASCII in unanalyzed data sections.

### 4. Stack Frame Heuristics (`stack_frame`)

- **Metric**: `local_vars_size`, `args_size`, and **instruction-level canary detection**.
- **Canary Detection**: The system identifies stack canaries by detecting security cookie initialization and XOR-based check patterns (e.g., `xor rcx, rbp; call __security_check_cookie`) rather than relying on variable names.

### 5. C++ VTable & Polymorphism Contexts (`vtable_contexts`)

- **Metric**: Detection of virtual function dispatch and class reconstruction.
- **Algorithm**: Groups methods by class using name analysis and NULL pointer breaks to identify class boundaries.

### 6. TLS Callback Analysis (`tls_callbacks`)

- **Metric**: Identification of code executing before the Entry Point, including scanning for anti-debug APIs and crypto constants.
- **Scoring**: Assigns a score based on the combination of anti-debug logic, lack of symbolic names, and presence of encryption/decryption constants.

---

## Analysis Systems

The plugin uses analysis engines to resolve binary patterns:

### Inter-procedural Data Flow Analysis

Tracks values across function boundaries using a **summary-based method** with LRU caching for performance:

- **Parameter Tracing**: Traces function pointers passed as arguments to their source in caller functions.
- **Global Tracker**: Monitors writes to global variables used as indirect call targets.
- **Return Value Summary**: Analyzes if functions return constant pointers or global addresses.

### Indirect Call & Jump Table Resolution

- **Backward Data Flow**: Traces register loads (up to 15-40 instructions) to resolve `call reg` targets, resolving obfuscation patterns like XOR/ADD/SUB.
- **Dual Jump Table Detection**: Combines IDA switch detection with a fallback engine for sparse or non-standard jump tables.
- **Confidence Scoring**: Every resolved target receives a score (0-100) based on segment permissions, instruction context (overlapping code detection), and call-flow validity (return point existence).

### Offline Code Generation (CPP Generator)

- **Hierarchy**: Generates a structured directory of `.cpp` and `.h` files.
- **Categorization**: Groups functions into C++ class method files or standalone global function files based on naming conventions.
- **Cleaned Source**: Replaces IDA escape sequences and wraps comments for readability.

---

## SQLite Database Schemas

### Tracking Database (`analyzed_files.db`)

**Purpose**: Ledger tracking the analysis status of all binaries.

#### Table: `analyzed_files`

| Column Name                     | Data Type | Description                                                   |
| :------------------------------ | :-------- | :------------------------------------------------------------ |
| `file_path`                     | TEXT      | **PRIMARY KEY**. Absolute path to the binary file.            |
| `base_dir`                      | TEXT      | The directory containing the binary file.                     |
| `file_name`                     | TEXT      | The name of the binary file, including its extension.         |
| `file_extension`                | TEXT      | The file's extension (e.g., `.exe`, `.dll`).                  |
| `md5_hash`                      | TEXT      | The MD5 cryptographic hash for change detection.              |
| `sha256_hash`                   | TEXT      | The SHA256 cryptographic hash for change detection.           |
| `analysis_db_path`              | TEXT      | **Relative path** to the individual analysis SQLite database. |
| `status`                        | TEXT      | Status: `PENDING`, `ANALYZING`, or `COMPLETE`.                |
| `analysis_flags`                | TEXT      | JSON string of the analysis configuration used.               |
| `analysis_start_timestamp`      | TIMESTAMP | Recorded when analysis began (used for stale lock recovery).  |
| `analysis_completion_timestamp` | TIMESTAMP | Recorded when analysis completed.                             |

---

### Individual Analysis Database (`{filename}_{hash}.db`)

**Purpose**: Stores results for a single binary.

#### Table: `file_info`

| Column Name              | Data Type | Description                            |
| :----------------------- | :-------- | :------------------------------------- |
| `file_path`              | TEXT      | Absolute path to the binary (PK).      |
| `base_dir`               | TEXT      | Directory containing the file.         |
| `file_name`              | TEXT      | Filename with extension.               |
| `file_extension`         | TEXT      | Extension (e.g., `.exe`, `.dll`).      |
| `file_size_bytes`        | BIGINT    | Total size in bytes.                   |
| `md5_hash`               | TEXT      | MD5 cryptographic hash.                |
| `sha256_hash`            | TEXT      | SHA256 cryptographic hash.             |
| `imports`                | TEXT      | JSON object of all imported functions. |
| `exports`                | TEXT      | JSON object of exported functions.     |
| `entry_point`            | JSON      | JSON array of detected entry points.   |
| `file_version`           | TEXT      | Resource file version string.          |
| `product_version`        | TEXT      | Product version string.                |
| `company_name`           | TEXT      | Vendor identification.                 |
| `file_description`       | TEXT      | File purpose description.              |
| `internal_name`          | TEXT      | Internal module name.                  |
| `original_filename`      | TEXT      | Original filename from PE header.      |
| `legal_copyright`        | TEXT      | Copyright string.                      |
| `product_name`           | TEXT      | Product name.                          |
| `time_date_stamp_str`    | TEXT      | Compilation timestamp.                 |
| `file_modified_date_str` | TEXT      | Filesystem modification date.          |
| `sections`               | TEXT      | JSON object of PE sections.            |
| `pdb_path`               | TEXT      | Path to PDB debug symbols.             |
| `rich_header`            | TEXT      | JSON object with Rich Header metadata. |
| `tls_callbacks`          | TEXT      | JSON array of TLS callback metadata.   |
| `is_net_assembly`        | BOOLEAN   | Flag for .NET binaries.                |
| `clr_metadata`           | TEXT      | JSON object with CLR header details.   |
| `idb_cache_path`         | TEXT      | Relative path to cached `.i64`/`.idb`. |
| `dll_characteristics`    | TEXT      | JSON object of DLL flags.              |
| `security_features`      | TEXT      | JSON object of feature assessments.    |
| `exception_info`         | TEXT      | Exception handling tables JSON.        |
| `load_config`            | TEXT      | PE Load Config structure JSON.         |
| `analysis_timestamp`     | TIMESTAMP | Completion time.                       |

#### Table: `functions`

| Column Name                   | Data Type | Description                         |
| :---------------------------- | :-------- | :---------------------------------- |
| `function_id`                 | INTEGER   | Unique primary key.                 |
| `function_signature`          | TEXT      | Fully demangled C++ signature.      |
| `function_signature_extended` | TEXT      | Extended type-safe signature.       |
| `mangled_name`                | TEXT      | Original decorated name.            |
| `function_name`               | TEXT      | Clean, short demangled name.        |
| `assembly_code`               | TEXT      | Complete disassembled instructions. |
| `decompiled_code`             | TEXT      | C/C++ source (Hex-Rays).            |
| `inbound_xrefs`               | TEXT      | Detailed JSON of callers.           |
| `outbound_xrefs`              | TEXT      | Detailed JSON of callees.           |
| `simple_inbound_xrefs`        | TEXT      | Simplified JSON caller list.        |
| `simple_outbound_xrefs`       | TEXT      | Simplified JSON callee list.        |
| `vtable_contexts`             | TEXT      | Enhanced C++ class reconstructions. |
| `global_var_accesses`         | TEXT      | JSON of global variable access.     |
| `dangerous_api_calls`         | TEXT      | JSON of insecure API calls.         |
| `string_literals`             | TEXT      | JSON of string literals.            |
| `stack_frame`                 | TEXT      | JSON of frame details.              |
| `loop_analysis`               | TEXT      | JSON of loop counts/blocks.         |
| `analysis_errors`             | TEXT      | JSON array of processing errors.    |
| `created_at`                  | TIMESTAMP | Record creation timestamp.          |

#### Table: `schema_version`

| Column Name         | Data Type | Description                                     |
| :------------------ | :-------- | :---------------------------------------------- |
| `version`           | INTEGER   | **PRIMARY KEY**. Schema version number.         |
| `description`       | TEXT      | Description of the schema version.              |
| `applied_timestamp` | TIMESTAMP | When this schema version was applied.           |
| `migration_notes`   | TEXT      | Details regarding migration from prior version. |

#### Indices

| Index Name                 | Table       | Column(s)                           | Purpose                                 |
| :------------------------- | :---------- | :---------------------------------- | :-------------------------------------- |
| `idx_file_info_lower_ext`  | `file_info` | `LOWER(file_extension)`             | Case-insensitive extension search.      |
| `idx_file_info_lower_name` | `file_info` | `LOWER(file_name)`                  | Case-insensitive filename search.       |
| `idx_functions_mangled`    | `functions` | `mangled_name COLLATE NOCASE`       | Case-insensitive mangled name lookups.  |
| `idx_functions_name`       | `functions` | `function_name COLLATE NOCASE`      | Case-insensitive function name lookups. |
| `idx_functions_signature`  | `functions` | `function_signature COLLATE NOCASE` | Case-insensitive signature search.      |

---

## Usage Notes for AI Agents

1.  **Registry Discovery**: Query `analyzed_files.db` to find individual module databases and verify analysis completeness across software packages.
2.  **Call Chain Reconstruction**: Use `simple_outbound_xrefs` from the `functions` table to build call chains. For indirect calls, refer to the `indirect_call_info` within the JSON.
3.  **Cross-Reference Analysis**: Utilize `inbound_xrefs` and `outbound_xrefs` to identify data and control flow relationships.
4.  **Heuristic Data Retrieval**: Use SQL `JSON_EXTRACT` to filter functions by technical metrics such as loop complexity, stack size, or anti-debug indicators.
5.  **Technical Verification**: Correlate observations in `decompiled_code` with the raw `assembly_code` and `stack_frame` (canary status) for technical validation.
